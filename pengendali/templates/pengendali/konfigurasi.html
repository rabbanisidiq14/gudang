<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Konfigurasi Pengendali</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f4f9;
      }
      header {
        background: #2c3e50;
        color: white;
        padding: 20px;
        text-align: center;
      }
      main {
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .toggle-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      .toggle-group button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        color: white;
        transition: background 0.2s;
      }
      .toggle-manual {
        background: #e74c3c;
      }
      .toggle-otomatis {
        background: #3498db;
      }
      .toggle-kipas {
        background: #f39c12;
      }
      .toggle-active {
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
      }

      form button {
        margin-top: 20px;
        padding: 10px 20px;
        border: none;
        background: #2ecc71;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      form button:hover {
        background: #27ae60;
      }
      .btn-kembali {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 20px;
        background: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        transition: background 0.2s;
      }
      .btn-kembali:hover {
        background: #2980b9;
      }
      @media (max-width: 480px) {
        main {
          margin: 10px;
          padding: 15px;
        }
        header {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Konfigurasi Pengendali</h1>
    </header>

    <main>
      <h2>Mode Kontrol</h2>
      <div class="toggle-group">
        <button id="manualBtn" class="toggle-manual">Manual</button>
        <button id="otomatisBtn" class="toggle-otomatis">Otomatis</button>
      </div>

      <h2>Kipas Manual</h2>
      <div class="toggle-group">
        <button id="kipasBtn" class="toggle-kipas">OFF</button>
      </div>

      <form method="post" id="form-konfigurasi">
        {% csrf_token %} {{ form.as_p }}
        <button type="submit">Simpan</button>
      </form>

      <a href="/" class="btn-kembali">‚Üê Kembali ke Dashboard</a>
    </main>

    <script>
      (() => {
        const manualBtn = document.getElementById("manualBtn");
        const otomatisBtn = document.getElementById("otomatisBtn");
        const kipasBtn = document.getElementById("kipasBtn");
        const formElement = document.getElementById("form-konfigurasi");
        const formFields = Array.from(
          formElement.querySelectorAll("input")
        ).filter((i) =>
          ["suhu_min", "suhu_max", "kelembapan_min", "kelembapan_max"].includes(
            i.name
          )
        );

        // Inisialisasi dari Django
        let modeManual =
          "{{ form.instance.mode_manual|yesno:'true,false' }}" === "true";
        let modeOtomatis =
          "{{ form.instance.mode_otomatis|yesno:'true,false' }}" === "true";
        let kipasStatus =
          "{{ form.instance.kipas_manual|yesno:'true,false' }}" === "true";

        function updateToggleUI() {
          manualBtn.classList.toggle("toggle-active", modeManual);
          otomatisBtn.classList.toggle("toggle-active", modeOtomatis);
          formFields.forEach((f) => (f.disabled = modeManual));
          kipasBtn.disabled = !modeManual;
        }

        function updateKipasUI() {
          kipasBtn.textContent = kipasStatus ? "ON" : "OFF";
          kipasBtn.classList.toggle("toggle-active", kipasStatus);
        }

        function sendJSON(data) {
          fetch("{% url 'konfigurasi_pengendali' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(data),
          }).catch(console.error);
        }

        manualBtn.addEventListener("click", () => {
          modeManual = true;
          modeOtomatis = false;
          updateToggleUI();
          sendJSON({ mode_manual: true, mode_otomatis: false });
        });

        otomatisBtn.addEventListener("click", () => {
          modeManual = false;
          modeOtomatis = true;
          updateToggleUI();
          sendJSON({ mode_manual: false, mode_otomatis: true });
        });

        kipasBtn.addEventListener("click", () => {
          if (!modeManual) return;
          kipasStatus = !kipasStatus;
          updateKipasUI();
          sendJSON({ kipas_manual: kipasStatus });
        });

        updateToggleUI();
        updateKipasUI();
      })();
    </script>
  </body>
</html>
